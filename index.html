<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Jumper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { overflow: hidden; background: linear-gradient(to bottom, #0a0a2a, #1a1a40); color: white; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #gameContainer { position: relative; width: 100%; max-width: 800px; height: 600px; margin: auto; border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(0, 200, 255, 0.5); }
        .distorted { filter: blur(8px) hue-rotate(90deg); }
        canvas { display: block; background: radial-gradient(circle at center, #000428, #004e92); transition: filter 0.3s; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 10, 30, 0.95); z-index: 100; padding: 20px; text-align: center; }
        #rulesScreen { text-align: left; align-items: center; overflow-y: auto; }
        .rules-content { max-width: 600px; background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 0.85rem; line-height: 1.4; }
        .hidden { display: none !important; }
        h1 { font-size: 4rem; margin-bottom: 20px; background: linear-gradient(to right, #00dbde, #fc00ff); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
        h2 { font-size: 2.5rem; margin-bottom: 10px; color: #00ffcc; }
        .btn { background: linear-gradient(to right, #00c6ff, #0072ff); color: white; border: none; padding: 12px 35px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; margin: 5px; transition: all 0.3s; box-shadow: 0 5px 20px rgba(0, 114, 255, 0.5); }
        .btn:hover { transform: scale(1.05); }
        .btn-secondary { background: linear-gradient(to right, #666, #333); }
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 50; pointer-events: none; gap: 10px; }
        .ui-box { background: rgba(0, 20, 40, 0.7); padding: 10px 15px; border-radius: 15px; border: 2px solid #00aaff; min-width: 90px; text-align: center; backdrop-filter: blur(5px); }
        #gravityWarning, #errorWarning { position: absolute; top: 85px; left: 50%; transform: translateX(-50%); padding: 5px 15px; border-radius: 20px; font-weight: bold; display: none; z-index: 6; animation: pulse 1s infinite; }
        #gravityWarning { background: rgba(255, 100, 0, 0.6); color: white; }
        #errorWarning { background: rgba(138, 43, 226, 0.8); color: white; top: 120px; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .ui-title { font-size: 0.8rem; color: #88ddff; }
        .ui-value { font-size: 1.5rem; font-weight: bold; color: #00ffcc; }
        #characterSelect { display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap; justify-content: center; }
        .character-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .character { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #333, #666); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; }
        .character.selected { border-color: #00ffcc; box-shadow: 0 0 20px #00ffcc; }
        .ability-text { font-size: 0.6rem; color: #00ffcc; max-width: 70px; }
        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; z-index: 50; pointer-events: none; }
        .control-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: 3px solid rgba(255, 255, 255, 0.5); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; color: white; pointer-events: auto; cursor: pointer; backdrop-filter: blur(5px); }
        .bar-container { position: absolute; left: 50%; transform: translateX(-50%); width: 200px; height: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 5px; display: none; z-index: 50; }
        #magnetBarContainer { bottom: 120px; border: 1px solid #ff00ff; }
        #shieldBarContainer { bottom: 135px; border: 1px solid #00ffff; }
        #blastBarContainer { bottom: 150px; border: 1px solid #ffffff; }
        #droneBarContainer { bottom: 165px; border: 1px solid #00ff00; }
        .bar-fill { width: 100%; height: 100%; border-radius: 4px; transition: width 0.1s linear; }
        #magnetBar { background: linear-gradient(to right, #ff00ff, #00ffff); }
        #shieldBar { background: linear-gradient(to right, #00ffff, #0088ff); }
        #blastBar { background: linear-gradient(to right, #ffffff, #ffaa00); }
        #droneBar { background: linear-gradient(to right, #00ff00, #aaff00); }
        #blastFlash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 200; transition: opacity 0.5s ease-out; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="blastFlash"></div>
        <canvas id="gameCanvas"></canvas>
        <div id="gravityWarning">‚ö†Ô∏è GRAVITY DISTORTION</div>
        <div id="errorWarning">‚ö†Ô∏è SYSTEM ERROR: INVERTED</div>
        
        <div id="ui">
            <div class="ui-box"><div class="ui-title">SCORE</div><div id="score" class="ui-value">0</div></div>
            <div class="ui-box"><div class="ui-title">BEST</div><div id="highScore" class="ui-value">0</div></div>
            <div class="ui-box"><div class="ui-title">COINS</div><div id="coins" class="ui-value">0</div></div>
            <div class="ui-box"><div class="ui-title">SPEED</div><div id="speed" class="ui-value">1.4x</div></div>
        </div>

        <div id="droneBarContainer" class="bar-container"><div id="droneBar" class="bar-fill"></div></div>
        <div id="blastBarContainer" class="bar-container"><div id="blastBar" class="bar-fill"></div></div>
        <div id="shieldBarContainer" class="bar-container"><div id="shieldBar" class="bar-fill"></div></div>
        <div id="magnetBarContainer" class="bar-container"><div id="magnetBar" class="bar-fill"></div></div>

        <div id="startScreen" class="screen">
            <h1>GALAXY JUMPER</h1>
            <div id="characterSelect">
                <div class="character-container"><div class="character selected" data-char="comet">üí´</div><span class="ability-text">Double Jump</span></div>
                <div class="character-container"><div class="character" data-char="superstar">üåü</div><span class="ability-text">Magnet King</span></div>
                <div class="character-container"><div class="character" data-char="smallstar">‚≠ê</div><span class="ability-text">Coin Collector</span></div>
                <div class="character-container"><div class="character" data-char="pulse">‚ö°</div><span class="ability-text">High Speed</span></div>
                <div class="character-container"><div class="character" data-char="flare">‚òÄÔ∏è</div><span class="ability-text">Slow Gravity</span></div>
            </div>
            <button id="startBtn" class="btn">LAUNCH MISSION</button>
            <button id="rulesBtn" class="btn btn-secondary">RULES</button>
        </div>

        <div id="rulesScreen" class="screen hidden">
            <h2 style="color: #ff00ff;">MISSION MANUAL</h2>
            <div class="rules-content">
                <p><strong>üõë HAZARDS:</strong> Avoid Red/Pink/Orange objects and Sentinels.</p>
                <p><strong>üöÄ FLIGHT:</strong> Tap UP to jump. Continuous tapping pushes obstacles down!</p>
                <p><strong>üõ∏ DRONE:</strong> Equips auto-firing drones (6-Bullet Triple Spread).</p>
                <p><strong>üß≤ MAGNET:</strong> Pulls nearby yellow coins toward you.</p>
                <p><strong>üõ°Ô∏è SHIELD:</strong> Absorbs one collision with an obstacle.</p>
                <p><strong>üí• SUPERNOVA:</strong> Clears all hazards for 5s (Spawns every 500pts).</p>
                <p><strong>üåÄ NEBULA:</strong> Inverts controls and blurs view temporarily.</p>
                <p><strong>üí∞ COINS:</strong> Collect yellow spheres to increase your total.</p>
            </div>
            <button id="backToMenuBtn" class="btn">BACK TO MENU</button>
        </div>

        <div id="gameOverScreen" class="screen hidden">
            <h2>MISSION FAILED</h2>
            <div class="score-display" id="finalScore" style="font-size: 2.5rem; color: #00ffcc; margin: 10px;">0</div>
            <div class="best-display" style="margin-bottom: 25px;">HIGH SCORE: <span id="finalBest">0</span></div>
            <div style="display: flex; gap: 15px;">
                <button id="restartBtn" class="btn">RETRY</button>
                <button id="menuBtn" class="btn btn-secondary">MENU</button>
            </div>
        </div>

        <div id="controls">
            <div class="control-btn" id="leftBtn">‚Üê</div>
            <div class="control-btn" id="jumpBtn">‚Üë</div>
            <div class="control-btn" id="rightBtn">‚Üí</div>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();
        const sounds = {
            jump: () => playTone(150, 'square', 0.1, 400),
            coin: () => playTone(800, 'sine', 0.1, 1200),
            hit: () => playTone(100, 'sawtooth', 0.3, 10),
            powerup: () => playTone(200, 'triangle', 0.2, 800),
            blast: () => playTone(50, 'sawtooth', 0.5, 100),
            shoot: () => playTone(600, 'square', 0.05, 300)
        };
        function playTone(freq, type, duration, endFreq) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            if (endFreq) osc.frequency.exponentialRampToValueAtTime(endFreq, audioCtx.currentTime + duration);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- GAME VARIABLES ---
        let canvas, ctx, gameActive = false, score = 0, coins = 0, speedMult = 1.4, gameSpeed = 7;
        let highScore = localStorage.getItem('galaxyJumperHighScore') || 0;
        let currentLane = 1, playerY = 300, isJumping = false, jumpVelocity = 0, centerY = 300;
        let platforms = [], obstacles = [], collectibles = [], powerups = [], nebulas = [], lasers = [], sentinels = [], particles = [];
        let stars = []; 
        let selectedCharacter = 'comet', animationId;
        let magnetActive = false, magnetTimer = 0, shieldActive = false, shieldTimer = 0, droneActive = false, droneTimer = 0, droneShootCooldown = 0;
        let blastActive = false, blastTimer = 0, invertedControls = false, invertedTimer = 0; 
        let lastInputTime = 0, lastSpawnY = 0;
        
        const INPUT_COOLDOWN = 180; 
        const rowInterval = 250; 
        
        const characters = { 'comet': 'üí´', 'superstar': 'üåü', 'smallstar': '‚≠ê', 'pulse': '‚ö°', 'flare': '‚òÄÔ∏è' };

        const scoreElement = document.getElementById('score'), highScoreElement = document.getElementById('highScore'), coinsElement = document.getElementById('coins');
        const errWarn = document.getElementById('errorWarning'), canvasEl = document.getElementById('gameCanvas');
        const startScreen = document.getElementById('startScreen'), rulesScreen = document.getElementById('rulesScreen'), gameOverScreen = document.getElementById('gameOverScreen');
        const blastFlash = document.getElementById('blastFlash'), droneBarContainer = document.getElementById('droneBarContainer'), droneBar = document.getElementById('droneBar');
        const magnetBarContainer = document.getElementById('magnetBarContainer'), magnetBar = document.getElementById('magnetBar');
        const shieldBarContainer = document.getElementById('shieldBarContainer'), shieldBar = document.getElementById('shieldBar');
        const blastBarContainer = document.getElementById('blastBarContainer'), blastBar = document.getElementById('blastBar');

        function init() {
            canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
            highScoreElement.textContent = highScore; 
            resizeCanvas(); 
            initStars();
            window.addEventListener('resize', resizeCanvas);
            
            document.getElementById('startBtn').onclick = startGame; 
            document.getElementById('restartBtn').onclick = startGame;
            document.getElementById('menuBtn').onclick = showMenu; 
            document.getElementById('backToMenuBtn').onclick = showMenu;
            document.getElementById('rulesBtn').onclick = () => { sounds.coin(); startScreen.classList.add('hidden'); rulesScreen.classList.remove('hidden'); };
            
            const setupControl = (el, type) => {
                const handleAction = (e) => {
                    e.preventDefault();
                    if (!gameActive) return;
                    const now = Date.now();
                    if (now - lastInputTime < INPUT_COOLDOWN) return;

                    if (type === 'jump') { jump(); lastInputTime = now; return; }
                    
                    let dir = type;
                    if (invertedControls) dir = (type === 'left' ? 'right' : 'left');
                    
                    let moved = false;
                    if(dir === 'left' && currentLane > 0) { currentLane--; moved = true; }
                    else if(dir === 'right' && currentLane < 2) { currentLane++; moved = true; }

                    if(moved) { sounds.coin(); lastInputTime = now; }
                };
                el.addEventListener('pointerdown', handleAction);
            };

            setupControl(document.getElementById('leftBtn'), 'left');
            setupControl(document.getElementById('rightBtn'), 'right');
            setupControl(document.getElementById('jumpBtn'), 'jump');
            
            document.querySelectorAll('.character').forEach(char => { char.addEventListener('click', () => {
                sounds.coin();
                document.querySelectorAll('.character').forEach(c => c.classList.remove('selected')); char.classList.add('selected'); selectedCharacter = char.dataset.char;
            });});
        }

        function initStars() {
            stars = [];
            for(let i=0; i<100; i++) stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 + 0.5, opacity: Math.random(), twinkleSpeed: (Math.random() * 0.02) + 0.005, direction: 1 });
        }

        function updateStars() {
            stars.forEach(star => {
                star.opacity += star.twinkleSpeed * star.direction;
                if(star.opacity > 1 || star.opacity < 0.2) star.direction *= -1;
                star.y += 0.5; if(star.y > canvas.height) star.y = 0;
            });
        }

        function drawStars() {
            stars.forEach(star => { ctx.globalAlpha = Math.max(0, Math.min(1, star.opacity)); ctx.fillStyle = "#ffffff"; ctx.beginPath(); ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2); ctx.fill(); });
            ctx.globalAlpha = 1.0; 
        }

        function resizeCanvas() { const container = document.getElementById('gameContainer'); canvas.width = container.clientWidth; canvas.height = container.clientHeight; centerY = canvas.height / 2; initStars(); }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            sounds.powerup(); 
            gameActive = true; score = 0; coins = 0; speedMult = 1.4; gameSpeed = 7; currentLane = 1; playerY = centerY;
            document.getElementById('speed').textContent = '1.4x';
            isJumping = false; jumpVelocity = 0; magnetActive = false; shieldActive = false; droneActive = false; blastActive = false;
            invertedControls = false; invertedTimer = 0;
            platforms = []; obstacles = []; collectibles = []; powerups = []; nebulas = []; lasers = []; sentinels = []; particles = []; lastSpawnY = rowInterval; 
            if (selectedCharacter === 'pulse') { speedMult = 1.6; gameSpeed = 8; document.getElementById('speed').textContent = '1.6x'; }
            
            startScreen.classList.add('hidden'); rulesScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden');
            [magnetBarContainer, shieldBarContainer, droneBarContainer, blastBarContainer].forEach(b => b.style.display = 'none');
            errWarn.style.display = 'none'; canvasEl.classList.remove('distorted');
            if (animationId) cancelAnimationFrame(animationId); gameLoop();
        }

        function showMenu() { gameActive = false; rulesScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); }
        function gameLoop() { if (!gameActive) return; update(); draw(); animationId = requestAnimationFrame(gameLoop); }

        function createExplosion(x, y, color) { sounds.hit(); for (let i = 0; i < 15; i++) particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, size: Math.random() * 5 + 2, color: color, life: 1.0 }); }

        function update() {
            score += 1; scoreElement.textContent = score;
            updateStars(); 

            if (score > 0 && score % 1000 === 0 && score <= 6000) { speedMult += 0.1; gameSpeed += 0.5; document.getElementById('speed').textContent = speedMult.toFixed(1) + 'x'; }

            if (invertedTimer > 0) { invertedTimer--; if (invertedTimer <= 0) { invertedControls = false; errWarn.style.display = 'none'; canvasEl.classList.remove('distorted'); } }
            if (blastActive) { blastTimer--; blastBar.style.width = (blastTimer / 300 * 100) + '%'; if (blastTimer <= 0) { blastActive = false; blastBarContainer.style.display = 'none'; } }
            
            if (droneActive) {
                droneTimer--; droneBar.style.width = (droneTimer / 360 * 100) + '%';
                if (droneShootCooldown-- <= 0) {
                    sounds.shoot(); const lw = canvas.width / 3; const cx = (currentLane * lw) + (lw / 2);
                    lasers.push({ x: cx - 50, y: playerY, vy: -18, vx: -2, width: 4, height: 20 }, { x: cx - 45, y: playerY, vy: -18, vx: 0, width: 4, height: 20 }, { x: cx - 40, y: playerY, vy: -18, vx: 2, width: 4, height: 20 }, { x: cx + 40, y: playerY, vy: -18, vx: -2, width: 4, height: 20 }, { x: cx + 45, y: playerY, vy: -18, vx: 0, width: 4, height: 20 }, { x: cx + 50, y: playerY, vy: -18, vx: 2, width: 4, height: 20 });
                    droneShootCooldown = 15;
                }
                if (droneTimer <= 0) { droneActive = false; droneBarContainer.style.display = 'none'; }
            }

            if (magnetActive) { magnetTimer--; magnetBar.style.width = (magnetTimer / 400 * 100) + '%'; if (magnetTimer <= 0) { magnetActive = false; magnetBarContainer.style.display = 'none'; } }
            if (shieldActive) { shieldTimer--; shieldBar.style.width = (shieldTimer / 400 * 100) + '%'; if (shieldTimer <= 0) { shieldActive = false; shieldBarContainer.style.display = 'none'; } }

            let scrollOffset = 0;
            if (isJumping) { playerY -= jumpVelocity; jumpVelocity *= 0.92; if (jumpVelocity < 0.5) isJumping = false; if (playerY < 150) { scrollOffset = 150 - playerY; playerY = 150; } }
            else { if (playerY < centerY) playerY += 2; if (playerY > centerY) playerY -= 1; }
            
            const currentMove = gameSpeed + scrollOffset; lastSpawnY += currentMove;

            [platforms, collectibles, powerups, nebulas, obstacles, sentinels].forEach(arr => {
                for(let i=arr.length-1; i>=0; i--) { arr[i].y += currentMove; if(arr[i].y > canvas.height + 200) arr.splice(i, 1); }
            });
            
            for (let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy + currentMove; p.life -= 0.02; if (p.life <= 0) particles.splice(i, 1); }

            for (let i = lasers.length - 1; i >= 0; i--) {
                lasers[i].y += lasers[i].vy; lasers[i].x += (lasers[i].vx || 0); let hit = false;
                for(let j = obstacles.length - 1; j >= 0; j--) {
                    let o = obstacles[j]; if(lasers[i].x < o.x + o.width && lasers[i].x + lasers[i].width > o.x && lasers[i].y < o.y + o.height && lasers[i].y + lasers[i].height > o.y) { createExplosion(o.x + o.width/2, o.y + o.height/2, o.color); obstacles.splice(j, 1); hit = true; break; }
                }
                if (!hit) { for(let k = sentinels.length - 1; k >= 0; k--) { let s = sentinels[k]; if(lasers[i].x < s.x + s.radius*2 && lasers[i].x + lasers[i].width > s.x && lasers[i].y < s.y + s.radius*2 && lasers[i].y + lasers[i].height > s.y) { createExplosion(s.x + s.radius, s.y + s.radius, 'white'); sentinels.splice(k, 1); hit = true; break; } } }
                if (hit || lasers[i].y < -50) lasers.splice(i, 1);
            }

            for(let i = sentinels.length - 1; i >= 0; i--) {
                let s = sentinels[i]; s.x += s.speedX; if (s.x <= 0 || s.x >= canvas.width - s.radius*2) s.speedX *= -1;
                if (checkCollection(s, s.radius + 15)) { if (blastActive) { createExplosion(s.x, s.y, 'white'); sentinels.splice(i,1); } else if (!shieldActive) gameOver(); else { shieldActive = false; sentinels.splice(i, 1); shieldBarContainer.style.display = 'none'; } }
            }

            if (blastActive) { obstacles = []; sentinels = []; nebulas = []; }
            for(let i = obstacles.length - 1; i >= 0; i--) { let obs = obstacles[i]; if (checkCollision(obs)) { if (!shieldActive) gameOver(); else { createExplosion(obs.x + obs.width/2, obs.y + obs.height/2, obs.color); shieldActive = false; obstacles.splice(i, 1); shieldBarContainer.style.display = 'none'; } } }

            const lw = canvas.width / 3; const px = (currentLane * lw) + (lw / 2);
            collectibles.forEach((c, i) => { 
                if (magnetActive) { const dx = px - (c.x + 10); const dy = playerY - (c.y + 10); const dist = Math.sqrt(dx*dx + dy*dy); if (dist < 300) { c.x += dx * 0.15; c.y += dy * 0.15; } }
                if (checkCollection(c, 25)) { sounds.coin(); coins += (selectedCharacter==='smallstar'?2:1); coinsElement.textContent = coins; collectibles.splice(i, 1); }
            });
            powerups.forEach((p, i) => { if (checkCollection(p, 30)) { activatePowerup(p.type); powerups.splice(i, 1); }});
            nebulas.forEach((n, i) => { if (checkCollection(n, 40)) { sounds.hit(); invertedControls = true; invertedTimer = 150; canvasEl.classList.add('distorted'); errWarn.style.display = 'block'; nebulas.splice(i, 1); } });

            if (lastSpawnY >= rowInterval) {
                lastSpawnY = 0;
                spawnRow();
            }
        }

        // --- ANTI-PATTERN PROCEDURAL SPAWN ENGINE ---
        function spawnRow() {
            const lw = canvas.width / 3;
            // Shuffling lanes [0, 1, 2] to ensure absolute random assignment of "Safe" vs "Danger"
            const laneOrder = [0, 1, 2].sort(() => Math.random() - 0.5);
            const safeLaneIdx = laneOrder[0]; // Guaranteed safe lane
            const dangerLaneA = laneOrder[1]; 
            const dangerLaneB = laneOrder[2];
            const baseRowY = -120;

            // Iterate through each lane to populate contents independently
            [0, 1, 2].forEach(lane => {
                // Individual y-offset for each object (Jitter) to break horizontal patterns
                const yOffset = (Math.random() * 40) - 20; 
                const finalY = baseRowY + yOffset;

                if (lane === safeLaneIdx) {
                    // Safe Lane: Platform or Coin (High frequency, No pattern)
                    const r = Math.random();
                    if (r < 0.6) createPlatform(lane, finalY);
                    else if (r < 0.8) createCollectible(lane, finalY);
                    // Else: Empty space
                } else {
                    // Danger Lanes: Independent random probability per lane
                    const r = Math.random();
                    
                    // Probabilities reset per object, preventing "sets" of patterns
                    if (r < 0.45) {
                        createObstacle(lane, finalY);
                    } else if (r < 0.85) {
                        createPlatform(lane, finalY);
                    } else if (r < 0.92) {
                        createSentinel(lane, finalY);
                    } else {
                        // Powerups, Nebulas, or empty
                        const roll = Math.random();
                        if (roll < 0.3) createNebula(lane, finalY);
                        else if (roll < 0.6) createPowerup(lane, finalY);
                    }
                }
            });
            
            // Supernova logic stays periodic
            if (score > 0 && score % 500 === 0) {
                 powerups.push({ x: Math.floor(Math.random()*3)*lw + (lw/2)-15, y: baseRowY - 150, type: 'blast' });
            }
        }

        function activatePowerup(type) {
            sounds.powerup();
            if (type === 'drone') { droneActive = true; droneTimer = 360; droneBarContainer.style.display = 'block'; }
            else if (type === 'magnet') { magnetActive = true; magnetTimer = 400; magnetBarContainer.style.display = 'block'; }
            else if (type === 'shield') { shieldActive = true; shieldTimer = 400; shieldBarContainer.style.display = 'block'; }
            else if (type === 'blast') { sounds.blast(); blastActive = true; blastTimer = 300; blastBarContainer.style.display = 'block'; blastFlash.style.opacity = '1'; setTimeout(() => { blastFlash.style.opacity = '0'; }, 300); obstacles = []; sentinels = []; nebulas = []; }
        }

        function createObstacle(lane, y) {
            const lw = canvas.width / 3; const r = Math.random(); const bx = lane * lw;
            if (r < 0.5) obstacles.push({ x: bx + (lw * 0.1), y: y, width: lw * 0.8, height: 20, color: '#ff0000' });
            else if (r < 0.75) obstacles.push({ x: bx + (lw/2) - 15, y: y, width: 30, height: 30, color: '#ff00ff' });
            else obstacles.push({ x: bx + (lw/2) - 15, y: y, width: 30, height: 30, color: '#ff8800' });
        }

        function createSentinel(lane, y) { const lw = canvas.width / 3; sentinels.push({ x: (lane * lw) + (lw/2)-12, y: y, radius: 12, speedX: (Math.random() - 0.5) * 6, color: 'white' }); }
        function createNebula(lane, y) { const lw = canvas.width / 3; nebulas.push({ x: (lane * lw), y: y, color: 'rgba(138, 43, 226, 0.6)' }); }
        function createCollectible(lane, y) { const lw = canvas.width / 3; collectibles.push({ x: lane * lw + (lw/2)-10, y: y }); }
        function createPowerup(lane, y) { const lw = canvas.width / 3; const pRoll = Math.random(); let type = pRoll < 0.4 ? 'magnet' : (pRoll < 0.7 ? 'drone' : 'shield'); powerups.push({ x: lane * lw + (lw/2)-15, y: y, type: type }); }
        function createPlatform(lane, y) { 
            const lw = canvas.width / 3; 
            const color = Math.random() > 0.5 ? '#0055ff' : '#00ffff'; 
            platforms.push({ x: lane * lw + (lw * 0.1), y: y, width: lw * 0.8, height: 15, color: color }); 
        }

        function draw() {
            ctx.fillStyle = '#000428'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawStars(); 
            platforms.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.width, p.height); });
            obstacles.forEach(o => { ctx.fillStyle = o.color; ctx.fillRect(o.x, o.y, o.width, o.height); });
            sentinels.forEach(s => { ctx.fillStyle = s.color; ctx.beginPath(); ctx.arc(s.x + s.radius, s.y + s.radius, s.radius, 0, Math.PI * 2); ctx.fill(); });
            nebulas.forEach(n => { let grad = ctx.createRadialGradient(n.x+40, n.y+30, 5, n.x+40, n.y+30, 40); grad.addColorStop(0, 'rgba(138, 43, 226, 0.8)'); grad.addColorStop(1, 'transparent'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(n.x+40, n.y+30, 40, 0, Math.PI*2); ctx.fill(); });
            particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); }); ctx.globalAlpha = 1.0;
            collectibles.forEach(c => { ctx.fillStyle = '#ffff00'; ctx.beginPath(); ctx.arc(c.x+10, c.y+10, 10, 0, Math.PI*2); ctx.fill(); });
            powerups.forEach(p => { ctx.font = '22px Arial'; ctx.fillText(p.type==='drone'?'üõ∏':(p.type==='magnet'?'üß≤':(p.type==='shield'?'üõ°Ô∏è':'üí•')), p.x, p.y+20); });
            lasers.forEach(l => { ctx.fillStyle = '#00ff00'; ctx.fillRect(l.x, l.y, l.width, l.height); });
            const lw = canvas.width / 3; let targetX = (currentLane * lw) + (lw / 2);
            ctx.font = '50px Arial'; ctx.textAlign = 'center'; ctx.fillText(characters[selectedCharacter], targetX, playerY);
            if(droneActive) { ctx.font = '20px Arial'; ctx.fillText('ü§ñ', targetX-45, playerY); ctx.fillText('ü§ñ', targetX+45, playerY); }
            if(shieldActive) { ctx.beginPath(); ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 3; ctx.arc(targetX, playerY, 40, 0, Math.PI*2); ctx.stroke(); }
        }

        function jump() { sounds.jump(); isJumping = true; jumpVelocity = 15; } 
        function checkCollision(o) { const lw = canvas.width/3; const px = (currentLane*lw)+(lw/2); return (playerY+15 > o.y && playerY-15 < o.y+o.height && px+15 > o.x && px-15 < o.x+o.width); }
        function checkCollection(o, r) { const lw = canvas.width/3; const px = (currentLane*lw)+(lw/2); const ox = (o.radius ? o.x + o.radius : o.x + 10); const oy = (o.radius ? o.y + o.radius : o.y + 10); return Math.sqrt(Math.pow(px-ox,2)+Math.pow(playerY-oy,2)) < r; }
        function gameOver() { sounds.hit(); gameActive = false; if (score > highScore) { highScore = score; localStorage.setItem('galaxyJumperHighScore', highScore); } document.getElementById('finalScore').textContent = score; document.getElementById('finalBest').textContent = highScore; gameOverScreen.classList.remove('hidden'); }
        window.onload = init;
    </script>
</body>
</html>
